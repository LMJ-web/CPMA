@{
    Layout = null;
    ViewBag.Title = "我的购物车";
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-wap-web-app-capable" content="yes">
    <meta name="apple-wap-web-app-status-bar-style" content="black-translucent">
    <title>我的购物车 </title>
    <!-- ionic框架  css -->
    <link href="~/PageUI/Cart/css/weixin.css" rel="stylesheet" type="text/css" />
    <link href="~/PageUI/Cart/css/ionic.min.css" rel="stylesheet" type="text/css" />
    <link href="~/PageUI/Cart/css/signin.css" rel="stylesheet" type="text/css" />
    <link href="~/PageUI/Cart/css/share.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="~/layui/css/layui.css" />

</head>
<body>
    <!--购物车-->
    <div>
        <!--header-->
        <div class="header_box">
            <div class="bar bar-header">
                <div id="tite" class="h1 title" style=" width: 72%; margin: 0 auto; ">
                    <font color="white"><b>我的购物车</b></font>
                </div>
                <a class="rig_shai" id="rem_s" href="javascript:void(0)" style="margin-right: 2%;position: absolute; top: 5px; right: 3%;color:white;">
                    <font color="white">编辑</font>
                </a>
            </div>
        </div>
        <div style="height:44px;"></div>
        <!-- header end -->
        <form method="post" name="cart_form" target="_self" id="cart_form" action="">
            <!--list-->
            <div class="commodity_list_box" name="cart_goods_list">
                <div class="cart_top">
                    <span>商品清单</span>
                    <p id="weights">数量</p>
                    <div class="clear"></div>
                </div>
                <!-- 商品列表 -->
                @*动态添加*@
                <!-- 商品列表 end -->
            </div>
            <!-- end -->
        </form>
        <!-- footer -->
        <div style="height:55px;"></div>
        <div class="settle_box">
            <dl class="all_check select">
                <dt><span id="all_pitch_on"></span><font>全选</font></dt>
            </dl>
            <dl class="total_amount">
                <dt>合计：<p id="total_price">¥<b>0</b></p></dt>
                <dd>不含运费</dd>
            </dl>
            <input type="hidden" name="gcs" id="gcs" />
            <a class="settle_btn" href="javascript:void(0);" id="confirm_cart" onclick="ClearCart();">结算</a>
            <a class="settle_btn" href="javascript:void(0);" id="confirm_cart1" onclick="big_cart_remove();">删除</a>
        </div>
        <!-- footer end -->
    </div>
</body>
</html>

<script type="text/javascript" src="~/Scripts/jquery-3.3.1.js"></script>
<script src="~/layui/layui.all.js" charset="utf-8"></script>
<script src="~/Scripts/page-public-method.js" type="text/javascript"></script>
<!-- ionic框架  js   -->
<script type="text/javascript" src="~/PageUI/Cart/js/ionic.bundle.min.js"></script>
<script type="text/javascript" src="~/PageUI/Cart/js/runend.js"></script>

@*全局变量*@
<script type="text/javascript">
    var i;
    //金额总和
    var money;
    //计算合计价格
    var cart_money;
    //全部商品ID
    var cart_id;
    //备份商品ID，用于全选后去掉全选又再次全选
    var cart_id_copy;
    //存放所有的 .commodity_box .select em
    var allThis;
    var user;

    //加载
    $(document).ready(function () {
        i = 0;

        //金额总和
        money = 0;

        //计算合计价格
        cart_money = new Object();

        //全部商品ID
        cart_id = new Object();

        //备份商品ID，用于全选后去掉全选又再次全选
        cart_id_copy = new Object();

        var cart_goodsList = sessionStorage.getItem("Cart_GoodsList");
        var html = "";
        if (cart_goodsList != "" && cart_goodsList != null) {
            var obj = JSON.parse(sessionStorage.getItem("Cart_GoodsList"));
            var count = GetJsonLength(obj);
            for (var i = 0; i < count; i++) {
                html += '<div class="commodity_box " style="background-color:white" >' +
                '<div class="commodity_list">' +
                ' <!--店名信息-->' +
                '<div class="tite_tim select">' +
                '<em aem="1" cart_id="84"></em>' +
                '<img src="/PageUI/Cart/img/icon-kin.png" style="width:3% ;height:auto;"/>' +
                '<span>' + obj[i].ShopName + '</span>' +
                '<div class="clear"></div>' +
                '</div>' +
                '<!--商品-->' +
                '<ul class="commodity_list_term layui-anim layui-anim-upbit" >' +
                '<li class="select">' +
                '<em aem="0" cart_id="84"></em>' +
                '<a href = "/Home/ShopYYIndex?ShopId=' + obj[i].ShopId + '" target="_black"><img src="' + obj[i].GoodsFMImgPath + '" ;/></a>' +
                '<div class="div_center">' +
                '<h4>' + obj[i].GoodsName + '</h4>' +
                '<span></span>' +
                '<p class="now_value"><i>￥</i><b class="cart_goods_price">' + obj[i].GoodsPrice + '</b></p>' +
                '</div>' +
                '<div class="div_right">' +
                '<i name="goods_reduce" class="' + i + '">-</i>' +
                '<span class="zi">1</span>' +
                '<input type="hidden" value="84">' +
                '<i name="goods_add"  class="' + i + '">+</i>' +
                '</div>' +
                '</li>' +
                '</ul>' +
                '<!--优惠信息-->' +
                '<div class="shop_ul_bottom account_info_box">' +
                ' <ul class="account_info">' +
                '<li class="i_text">' +
                '<span class="info_name xi_cu">包邮</span>' +
                '<span class="info_name">商家包邮</span>' +
                '</li>' +
                '</ul>' +
                '</div>' +
                '</div>' +
                '</div>';
            }
            $("[name='cart_goods_list']").append(html);
            //获取所有的 .commodity_box .select em
            allThis = $(".commodity_box .select em");
        } else {
            layer.msg("购物车暂无商品，快去购买吧！");
        }
        user = JSON.parse(sessionStorage.getItem("user"));
    });

    //加事件
    $(document).on("click", "[name='goods_reduce']", function () {
        reducew(this);
    });

    //减事件
    $(document).on("click", "[name='goods_add']", function () {
        plusw(this);
    });

    //选择 结算 商品
    $(document).on("click", ".select em", function () {
        var su = $(this).attr("aem");
        var carts_id = $(this).attr("cart_id");
        var totalH = $("#total_price b").text(); /* 合计金额  */
        if (su == 0) {
            /* 单选商品  */
            if ($(this).hasClass("pitch_on")) {
                /*去该店全选*/
                $(this).parents("ul").siblings(".select").find("em").removeClass("pitch_on");
                /*去底部全选*/
                $("#all_pitch_on").removeClass("pitch_on");
                $(this).removeClass("pitch_on");
                GetTotalPrice();
                cart_id[carts_id] = "";
                delete cart_id[carts_id];
            } else {
                $(this).addClass("pitch_on");
                var n = $(this).parents("ul").children().find(".pitch_on");
                var n1 = $(this).parents("ul").children();
                GetTotalPrice();
                cart_id[carts_id] = "";
                /*该店商品全选中时*/
                if (n.length == n1.length) {
                    $(this).parents("ul").siblings(".select").find("em").addClass("pitch_on");
                }
                /*商品全部选中时*/
                var fot = $(".commodity_list_box .tite_tim .pitch_on");
                var fot1 = $(".commodity_list_box .tite_tim em");
                if (fot.length == fot1.length)
                    $("#all_pitch_on").addClass("pitch_on");
            }
        } else {
            /* 全选该店铺  */
            if ($(this).hasClass("pitch_on")) {
                //取消选中
                /*去底部全选*/
                $("#all_pitch_on").removeClass("pitch_on");
                $(this).removeClass("pitch_on");
                $(this).parent().siblings("ul").find("em").removeClass("pitch_on");
                delete cart_id[carts_id];
                GetTotalPrice();
            } else {
                //选中

                $(this).addClass("pitch_on");

                $(this).parent().siblings("ul").find("em").addClass("pitch_on");

                cart_id[carts_id] = "";
                /*商品全部选中时*/
                var fot = $(".commodity_list_box .tite_tim .pitch_on");
                var fot1 = $(".commodity_list_box .tite_tim em");
                if (fot.length == fot1.length)
                    $("#all_pitch_on").addClass("pitch_on");
                GetTotalPrice();
            }
        }

        //计算选择数值
        number();

    });

    //计算已经选择的商品价格
    function GetTotalPrice() {
        var totalPrice = 0;
        var all_emObj = $(".commodity_list_term .select em");/* 全部商品的选中状态 */
        var all_priceObj = $(".commodity_box .select .cart_goods_price");/* 全部商品单价 */
        var all_numObj = $(".commodity_box .select .zi");  /* 全部商品数量 */
        var length = all_emObj.length;
        for (var i = 0; i < length; i++) {
            if (all_emObj.eq(i).hasClass("pitch_on")) {
                totalPrice += (parseFloat(all_priceObj.eq(i).text()) * parseFloat(all_numObj.eq(i).text()));
            }
        }
        $("#total_price").find("b").text(totalPrice);
        SetCartListNum();
    }

    /* 底部全选 */
    var bot = 0;
    $("#all_pitch_on").click(function () {
        if (bot == 0) {
            $(this).addClass("pitch_on");
            allThis.removeClass("pitch_on");
            allThis.addClass("pitch_on");
            bot = 1;
            //重新加入属性对象
            for (var key in cart_id_copy) {
                cart_id[key] = "";
            }
            /*总价格*/
            GetTotalPrice();
        } else {
            $(this).removeClass("pitch_on");
            allThis.removeClass("pitch_on");
            $("#total_price b").text("0");
            bot = 0;
            //移除全部对象
            for (var key in cart_id) {
                delete cart_id[key];
            }
        }
        //计算选择数值
        number();
    });

    /* 编辑商品 */
    var topb = 0;
    $("#rem_s").click(function () {
        if (topb == 0) {
            $(this).text("完成");
            $(".total_amount").hide(); /* 合计  */
            $("#confirm_cart").hide(); /* 结算  */
            $("#confirm_cart1").show(); /* 删除 */
            topb = 1;
        } else {
            topb = 0;
            $(this).text("编辑");
            $(".total_amount").show(); /* 合计  */
            $("#confirm_cart").show(); /* 结算  */
            $("#confirm_cart1").hide(); /* 删除 */
            allThis.removeClass("pitch_on"); /* 取消所有选择  */
            $("#all_pitch_on").removeClass("pitch_on"); /* 取消所有选择  */
            $("#total_price b").text("0"); /*合计价格清零*/
        }

    });

    //结算的数量
    function number() {
        var num = 0;
        var all_emObj = $(".commodity_list_term .select em");/* 全部商品的选中状态 */
        var length = all_emObj.length;
        for (var i = 0; i < length; i++) {
            if (all_emObj.eq(i).hasClass("pitch_on")) {
                num++;
            }
        }
        //将选择的放入到计算里面
        $("#confirm_cart").html("结算(" + num + ")");
    }

    /* 加减 */
    function reducew(obj) {
        //减
        var goodsListObj = JSON.parse(sessionStorage.getItem("Cart_GoodsList"));
        var $this = $(obj);
        var index = parseInt($this.attr("class"));
        var totalH = $("#total_price b").text(); /* 合计金额  */
        var ise = $this.siblings("span").text();
        var gc_id = $this.siblings("input").val();

        if (parseInt(ise) <= 1) {
            $this.siblings("span").text("1");
            goodsListObj[index].Num = 1;
        } else {
            var n = parseInt(ise) - 1;
            $this.siblings("span").text(n);
            goodsListObj[index].Num = n;
            GetTotalPrice();
        }
        sessionStorage.setItem("Cart_GoodsList", JSON.stringify(goodsListObj));
    };
    function plusw(obj) {
        //加
        var goodsListObj = JSON.parse(sessionStorage.getItem("Cart_GoodsList"));
        var $this = $(obj);
        var index = parseInt($this.attr("class"));
        var totalH = $("#total_price b").text(); /* 合计金额  */
        var ise = $this.siblings("span").text();
        var gc_id = $this.siblings("input").val();
        var n = parseInt(ise) + 1;
        goodsListObj[index].Num = n;
        $this.siblings("span").text(n);
        GetTotalPrice();
        sessionStorage.setItem("Cart_GoodsList", JSON.stringify(goodsListObj));
    }

    //删除--并重新分配索引，从0开始
    function big_cart_remove() {
        var leftArr = new Array();//存放剩下的商品索引
        var obj = JSON.parse(sessionStorage.getItem("Cart_GoodsList"));
        var newObj_string = "{}";//存放剩下的商品
        var all_emObj = $(".commodity_list_term .select em");/* 全部商品的选中状态 */
        var length = GetJsonLength(obj);
        for (var i = 0; i < length; i++) {
            if (all_emObj.eq(i).hasClass("pitch_on")) {
                delete obj[i];
            } else {
                leftArr.push(i);
            }
        }
        length = leftArr.length;
        //更新购物车--重新分配索引
        for (var i = 0; i < length; i++) {
            if (i == 0) {
                var index = newObj_string.lastIndexOf("}");
                var flg = '"' + i + '":' + JSON.stringify(obj[leftArr[i]]) + '';
                newObj_string = Insert_flg(newObj_string, flg, index);

            } else {
                var index = newObj_string.lastIndexOf("}");
                var flg = ',"' + i + '":' + JSON.stringify(obj[leftArr[i]]) + '';
                newObj_string = Insert_flg(newObj_string, flg, index);
            }
        }
        if (newObj_string == null || newObj_string == "" || newObj_string == "{}") {
            sessionStorage.removeItem("Cart_GoodsList");
            layer.msg("购物车已无数据！");
        } else {
            layer.msg("删除成功！");
            sessionStorage.setItem("Cart_GoodsList", newObj_string);
        }
        $(".commodity_list_term .pitch_on").parent().remove();
        $(".commodity_list .tite_tim > em.pitch_on").parents(".commodity_box").remove();
        GetTotalPrice();
    }

    //设置购物车清单数量
    function SetCartListNum() {
        var cart_goodsList = sessionStorage.getItem("Cart_GoodsList");
        if (cart_goodsList != null && cart_goodsList != "") {
            var obj = JSON.parse(cart_goodsList);
            var length = GetJsonLength(obj);
            //操控父级窗口的标签
            $("#xuanfu_cart_num", parent.document).text(length);
        } else {
            $("#xuanfu_cart_num", parent.document).text(0);
        }
    }

    //结算
    function ClearCart() {
        if (user != "" && user != null) {
            var goodsArr = {};
            var index = 0;
            var goodsListObj = JSON.parse(sessionStorage.getItem("Cart_GoodsList"));
            var all_emObj = $(".commodity_list_term .select em");/* 全部商品的选中状态 */
            var all_priceObj = $(".commodity_box .select .cart_goods_price");/* 全部商品单价 */
            var all_numObj = $(".commodity_box .select .zi");  /* 全部商品数量 */
            var length = GetJsonLength(goodsListObj);
            //取得购物车Json中的值
            for (var i = 0; i < length; i++) {
                if (all_emObj.eq(i).hasClass("pitch_on")) {
                    goodsArr[index] = {};
                    goodsArr[index][0] = goodsListObj[i].GoodsId;
                    goodsArr[index][1] = goodsListObj[i].ShopId;
                    goodsArr[index][2] = goodsListObj[i].Num;
                    index++;
                }
            }
            $.ajax({
                url: "/User/ClearCart",
                data: { UserName: user.UserName, GoodsList: goodsArr },
                async: false,
                type: "post",
                dataType: "json",
                success: function (data) {
                    if (data) {
                        big_cart_remove();
                        layer.msg("结算成功！");
                    } else if (data == false) {
                        layer.msg("结算失败，余额不足，请及时充值！");
                    } else if (data == "" || data == null) {
                        layer.msg("结算异常！");
                    }
                }
            });

        } else {
            layer.msg("请先登录！");
        }
    }

    //跳转到商店信息頁面
    function GotoShopIndex(shopId) {
        window.location.href = "/Home/ShopYYIndex?ShopId=" + shopId;
    }
</script>
